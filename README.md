# 📚 SESC Schedule Parser

> Telegram-бот для отслеживания изменений и получения учебного расписания СУНЦ УрФУ

Этот проект представляет собой полнофункциональный Telegram-бот, который позволяет пользователям запрашивать расписание на выбранный день недели, а также автоматически получать уведомления об актуальных изменениях в расписании после регистрации.

---

## 🚀 Технологический стек

### Backend
- **Python 3.12** — основной язык программирования
- **Aiogram 3.3.0** — асинхронный фреймворк для Telegram Bot API
- **Aiogram Dialog** — система диалогов для бота
- **SQLAlchemy 2.0.29** — ORM для работы с базой данных
- **Alembic 1.13.1** — система миграций базы данных
- **AsyncPG** — асинхронный драйвер для PostgreSQL
- **APScheduler 3.10.4** — планировщик задач для автоматической отправки уведомлений

### База данных
- **PostgreSQL 15** — реляционная база данных

### Message Queue & Communication
- **NATS** — система обмена сообщениями для асинхронной обработки задач
- **gRPC** — межсервисное взаимодействие с сервисом генерации изображений
- **Protobuf** — сериализация данных для gRPC

### Парсинг и обработка данных
- **BeautifulSoup4 4.12.3** — парсинг HTML
- **AioHTTP 3.9.3** — асинхронные HTTP-запросы
- **Requests 2.31.0** — синхронные HTTP-запросы

### Интернационализация
- **Fluentogram** — система локализации
- **Fluent-compiler** — компилятор переводов
- Поддержка языков: русский, английский, арабский, чешский, немецкий, иврит, японский, корейский, польский, китайский

### Валидация и конфигурация
- **Pydantic 2.5.3** — валидация данных
- **Python-dotenv 1.0.1** — управление переменными окружения

### Инфраструктура
- **Docker & Docker Compose** — контейнеризация и оркестрация сервисов
- **Alpine Linux** — легковесный базовый образ для контейнеров

### Дополнительные сервисы
- **Drawing Service (C# .NET 9.0)** — микросервис для генерации изображений расписания с использованием gRPC

---

## 📁 Структура проекта

```
SESC_schedule_parser/
│
├── 📂 src/                          # Основной исходный код приложения
│   ├── 📂 tgbot/                    # Модули Telegram-бота
│   │   ├── bot.py                   # Точка входа бота, настройка диспетчера и планировщика
│   │   ├── admin.py                 # Административные функции
│   │   ├── auxiliary.py             # Вспомогательные функции и роутеры
│   │   ├── parser.py                # Парсинг расписания с сайта
│   │   ├── sesc_info.py             # Информация о СУНЦ
│   │   ├── text.py                  # Текстовые сообщения
│   │   ├── keyboard.py              # Клавиатуры для бота
│   │   ├── feedback.py              # Обработка обратной связи
│   │   │
│   │   ├── 📂 main_work/             # Основная функциональность
│   │   │   ├── mainPage.py           # Главная страница бота
│   │   │   ├── registration.py      # Регистрация пользователей
│   │   │   ├── relogin.py            # Повторная авторизация
│   │   │   ├── allSchedule.py        # Получение полного расписания
│   │   │   └── optional_menu.py      # Дополнительное меню
│   │   │
│   │   ├── 📂 changes/               # Модуль отслеживания изменений
│   │   │   ├── changes.py            # Логика отправки изменений
│   │   │   ├── changes_db.py         # Работа с БД для изменений
│   │   │   ├── models.py             # Модели данных изменений
│   │   │   └── schemas.py            # Схемы валидации изменений
│   │   │
│   │   ├── 📂 elective_course/       # Модуль факультативных курсов
│   │   │   ├── elective_course.py    # Основная логика факультативов
│   │   │   ├── dialogs.py            # Диалоги для работы с факультативами
│   │   │   ├── admin_teacher_work.py  # Работа администраторов и преподавателей
│   │   │   ├── user_work.py          # Работа пользователей с факультативами
│   │   │   ├── elective_info.py      # Информация о факультативах
│   │   │   ├── elective_text.py      # Тексты для факультативов
│   │   │   ├── getters.py            # Геттеры данных
│   │   │   ├── utils.py              # Утилиты для факультативов
│   │   │   ├── models.py             # Модели данных факультативов
│   │   │   ├── schemas.py            # Схемы валидации факультативов
│   │   │   ├── states.py             # Состояния FSM для факультативов
│   │   │   └── 📂 elective_transactions/  # Транзакции факультативов
│   │   │       ├── elective_transactions.py
│   │   │       └── models.py
│   │   │
│   │   ├── 📂 settings/              # Модуль настроек
│   │   │   ├── dialogs.py           # Диалоги настроек
│   │   │   ├── handlers.py          # Обработчики настроек
│   │   │   ├── getters.py           # Геттеры для настроек
│   │   │   ├── settings_text.py     # Тексты настроек
│   │   │   └── states.py            # Состояния FSM для настроек
│   │   │
│   │   ├── 📂 user_models/           # Модели пользователей
│   │   │   ├── models.py            # SQLAlchemy модели пользователей
│   │   │   ├── schemas.py           # Pydantic схемы пользователей
│   │   │   └── db.py                # Работа с БД пользователей
│   │   │
│   │   ├── 📂 i18n/                  # Интернационализация
│   │   │   ├── utils.py              # Утилиты для локализации
│   │   │   └── 📂 [языки]/           # Переводы (ru, en, ar, cs, de, he, ja, ko, pl, zh)
│   │   │       └── main.ftl          # Файлы переводов Fluent
│   │   │
│   │   └── 📂 middlewares/           # Middleware для бота
│   │       ├── close_dialog.py       # Закрытие диалогов
│   │       └── delete_last_message.py # Удаление последних сообщений
│   │
│   ├── 📂 utils/                     # Утилиты проекта
│   │   ├── aiogram_utils.py          # Утилиты для Aiogram
│   │   ├── dialogs_utils.py          # Утилиты для диалогов
│   │   ├── drawer_utils.py           # Утилиты для работы с изображениями
│   │   ├── nats_connect.py           # Подключение к NATS
│   │   └── 📂 delayed_remove_elective_changes/  # Отложенное удаление изменений
│   │       └── [файлы обработки отложенных задач]
│   │
│   ├── config.py                     # Конфигурация приложения
│   ├── database.py                   # Настройка подключения к БД
│   └── my_typing.py                  # Типы данных проекта
│
├── 📂 migrations/                    # Миграции базы данных (Alembic)
│   ├── env.py                        # Конфигурация окружения Alembic
│   ├── script.py.mako                # Шаблон для миграций
│   └── 📂 versions/                  # История миграций
│       └── [файлы миграций].py
│
├── 📂 Drawing/                       # C# микросервис генерации изображений
│   ├── Drawing.sln                   # Solution файл
│   └── 📂 Drawing/                   # Основной проект
│       ├── Program.cs                # Точка входа сервиса
│       ├── Drawing.csproj            # Файл проекта
│       ├── Dockerfile                # Docker образ для сервиса
│       ├── GeneralDrawer.cs          # Основной класс генерации
│       ├── 📂 Models/                # Модели данных
│       ├── 📂 Services/              # Сервисы (gRPC)
│       ├── 📂 Protos/                # Protobuf определения
│       ├── 📂 Resources/             # Ресурсы (шрифты)
│       └── 📂 StylesImages/          # Изображения стилей расписания
│
├── 📂 nats/                          # Конфигурация NATS
│   ├── 📂 config/                    # Конфигурационные файлы
│   │   └── server.conf               # Конфигурация NATS сервера
│   └── 📂 data/                      # Данные NATS (JetStream)
│
├── 📂 proto/                         # Сгенерированные Python файлы из Protobuf
│
├── 📂 schedules/                     # Генерируемые изображения расписания
│
├── 📂 scripts/                       # Вспомогательные скрипты
│   ├── add_electives_from_xlsx.py    # Импорт факультативов из Excel
│   └── elec.xlsx                     # Пример файла с факультативами
│
├── 📂 test/                          # Тесты
│   ├── test_db.py                    # Тесты базы данных
│   └── test_parser.py                # Тесты парсера
│
├── 📄 Dockerfile                     # Docker образ для Python бота
├── 📄 docker-compose.yaml            # Оркестрация всех сервисов
├── 📄 alembic.ini                    # Конфигурация Alembic
├── 📄 requirements.txt               # Python зависимости
├── 📄 bot.sh                         # Скрипт запуска бота
└── 📄 README.md                      # Этот файл
```

---

## 🛠️ Основные возможности

### Для пользователей
- 📅 **Просмотр расписания** — получение расписания на любой день недели
- 🔔 **Уведомления об изменениях** — автоматические уведомления о изменениях в расписании
- 🎨 **Кастомизация стилей** — выбор стиля отображения расписания
- 🌍 **Многоязычность** — поддержка 10 языков интерфейса
- 📚 **Факультативные курсы** — просмотр и запись на факультативные курсы
- ⚙️ **Настройки** — персонализация работы с ботом

### Для администраторов и учителей
- 📝 **Управление факультативами** — создание и редактирование курсов

---

## 🔧 Установка и запуск

### Требования
- Docker и Docker Compose
- Python 3.12+ (для локальной разработки)
- PostgreSQL 15
- NATS Server

### Быстрый старт

1. **Клонируйте репозиторий**
```bash
git clone <repository-url>
cd SESC_schedule_parser
git submodule init
git submodule update
```

2. **Создайте файл `.env`** с необходимыми переменными окружения:
```env
POSTGRES_HOST=postgres_db
POSTGRES_PORT=5432
POSTGRES_DB=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
TOKEN=your_telegram_bot_token
PATH_TO_FONT=/path/to/font
ADMINS=admin_id1_admin_id2
PATH_TO_PROJECT=/usr/project
NATS_SERVER=nats://nats:4222
NATS_DELAYED_CONSUMER_SUBJECT=delayed.elective.changes
NATS_DELAYED_CONSUMER_STREAM=delayed_elective_changes
NATS_DELAYED_CONSUMER_DURABLE_NAME=delayed_consumer
```

3. **Запустите проект через Docker Compose**
```bash
docker-compose up --build -d
```

---

## 📝 Миграции базы данных

Проект использует Alembic для управления миграциями:

```bash
# Создать новую миграцию
alembic revision --autogenerate -m "описание изменений"

# Применить миграции
alembic upgrade head

# Откатить последнюю миграцию
alembic downgrade -1
```

---

## 🏗️ Архитектура

Проект построен на микросервисной архитектуре:

- **Telegram Bot Service** (Python) — основной сервис бота
- **Drawing Service** (C# .NET) — генерация изображений расписания через gRPC
- **PostgreSQL** — хранение данных пользователей и расписания
- **NATS** — асинхронная обработка задач и очереди сообщений

Сервисы взаимодействуют через:
- **gRPC** — для синхронного взаимодействия с Drawing Service
- **NATS** — для асинхронной обработки отложенных задач
